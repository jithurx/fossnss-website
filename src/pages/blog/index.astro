---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getImageUrl, getPageUrl } from '../../utils/imageUrl';

// --- Hybrid Content Fetching ---

// 1. Fetch from Local Markdown
const localPosts = await getCollection('blog');
const formattedLocalPosts = localPosts.map(post => ({
  slug: `/blog/${post.slug}`,
  title: post.data.title,
  date: post.data.date,
  cover: post.data.cover, // We need the cover
  desc: post.data.desc    // and description
}));

// 2. Fetch from Server (Optional)
let serverPosts = [];
const strapiApiUrl = import.meta.env.STRAPI_API_URL;

if (strapiApiUrl) {
  try {
    // Make sure to populate cover and add desc in your Strapi query
    const response = await fetch(`${strapiApiUrl}/api/blog-posts?populate=cover`); 
    
    if (response.ok) {
      const data = await response.json();
      if (data && Array.isArray(data.data)) {
        serverPosts = data.data.map(post => ({
          slug: `/blog/server/${post.attributes.slug}`, 
          title: post.attributes.title,
          date: new Date(post.attributes.publishedAt),
          // Handle Strapi's complex image object structure
          cover: post.attributes.cover?.data?.attributes?.url 
                 ? `${strapiApiUrl}${post.attributes.cover.data.attributes.url}` 
                 : null,
          desc: post.attributes.desc
        }));
      } else { console.warn('Strapi response format is not as expected.'); }
    } else { console.warn(`Failed to fetch from Strapi: ${response.statusText}`); }
  } catch (e) {
    if (e instanceof Error) {
      console.error('Strapi server is offline or unreachable.');
      console.error(e.message);
    }
  }
}

// 3. Merge and Sort
const allPosts = [...formattedLocalPosts, ...serverPosts].sort(
  (a, b) => b.date.getTime() - a.date.getTime()
);
---
<BaseLayout title="Blog">
  <div class="container mx-auto p-4 max-w-5xl"> {/* Wider container for cards */}
    <h1 class="text-4xl font-bold mb-6">Blog Posts</h1>
    
    {/* ... (Info box remains the same) ... */}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {allPosts.map(post => (
        <a 
          href={getPageUrl(post.slug)} 
          class="block border border-gray-200 dark:border-gray-700 rounded-lg shadow hover:shadow-lg transition-shadow bg-white dark:bg-gray-800 overflow-hidden"
        >
          
          {/* Card Image */}
          {post.cover ? (
            <img 
              src={getImageUrl(post.cover)} 
              alt={post.title} 
              class="w-full h-48 object-cover" {/* Fixed height for consistency */}
            />
          ) : (
            <div class="w-full h-48 bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400">
              No Image
            </div>
          )}

          {/* Card Content */}
          <div class="p-4">
            <h2 class="text-xl font-semibold text-blue-600 dark:text-blue-400 mb-2 truncate" title={post.title}>
              {post.title}
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
              {post.date.toDateString()}
            </p>
            {post.desc && (
              <p class="text-gray-700 dark:text-gray-300 mt-2 text-sm h-10 overflow-hidden text-ellipsis">
                {post.desc}
              </p>
            )}
          </div>
        </a>
      ))}
    </div>

    {allPosts.length === 0 && (
      <p>No blog posts found. Add some to `src/content/blog/` to get started.</p>
    )}
  </div>
</BaseLayout>