---
import BaseLayout from '../layouts/BaseLayout.astro';
import TroopLayout from '../components/TroopLayout.astro';
import { getImageUrl } from '../utils/imageUrl';
import fs from 'node:fs';
import path from 'node:path';

// Function to extract GitHub username from URL or avatar
function extractGithubUsername(url?: string, avatar?: string): string | undefined {
  if (url) {
    const ghMatch = url.match(/github\.com\/([^/]+)/);
    if (ghMatch) return ghMatch[1];
  }
  if (avatar) {
    const avatarMatch = avatar.match(/github\.com\/([^.]+)\.png/);
    if (avatarMatch) return avatarMatch[1];
  }
  return undefined;
}

// Function to parse frontmatter from markdown
function parseFrontmatter(content: string) {
  const match = content.match(/^---\n([\s\S]*?)\n---/);
  if (!match) return {};
  
  const frontmatter: Record<string, any> = {};
  const lines = match[1].split('\n');
  
  for (const line of lines) {
    const m = line.match(/^([^:]+):\s*"?(.*?)"?\s*$/);
    if (m) {
      frontmatter[m[1].trim()] = m[2].trim();
    }
  }
  
  return frontmatter;
}

// Load members for 2021
const year = '2021';
const contentRoot = path.join(process.cwd(), 'src', 'content', 'members');
const yearDir = path.join(contentRoot, year);

// Get all available years
const years = fs.readdirSync(contentRoot)
  .filter(f => fs.statSync(path.join(contentRoot, f)).isDirectory())
  .sort((a, b) => b.localeCompare(a)); // Sort years in descending order

let members = [];
if (fs.existsSync(yearDir)) {
  const files = fs.readdirSync(yearDir).filter(f => f.endsWith('.md'));
  members = files.map(file => {
    const content = fs.readFileSync(path.join(yearDir, file), 'utf-8');
    const data = parseFrontmatter(content);
    const username = extractGithubUsername(data.url, data.avathar);
    
    return {
      name: data.name || username || file.replace(/\.md$/, ''),
      username,
      role: data.designation
    };
  });

  // Sort members (leaders first, then alphabetically)
  members.sort((a, b) => {
    const aIsLeader = (a.role || '').toLowerCase().includes('lead');
    const bIsLeader = (b.role || '').toLowerCase().includes('lead');
    if (aIsLeader !== bIsLeader) return aIsLeader ? -1 : 1;
    return (a.name || '').localeCompare(b.name || '');
  });
}
---

<BaseLayout title={`FOSSNSS Team ${year}`}>
  <section class="container mx-auto p-4 max-w-6xl">
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-2">Meet Our Team</h1>
      <div class="w-24 h-1 bg-blue-600 mx-auto"></div>
    </header>

    <div class="mb-16 text-center">
      <div class="text-center">
        <a href="https://scholar.google.co.in/citations?user=PwHP6YoAAAAJ&hl=en" 
           target="_blank" 
           rel="noopener noreferrer"
           class="inline-flex flex-col items-center hover:opacity-90 transition-opacity">
          <div class="w-48 h-48 mb-4 overflow-hidden rounded-full bg-gray-100 dark:bg-gray-700 border-4 border-blue-600">
            <img
              src={getImageUrl('/content-images/staff/anuraj.jpeg')}
              alt="Anuraj Mohan"
              class="w-full h-full object-cover"
            />
          </div>
          <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Anuraj Mohan</h2>
          <p class="text-lg text-gray-600 dark:text-gray-400">Staff Co-ordinator</p>
        </a>
      </div>
    </div>

    <TroopLayout year={year} years={years} members={members} />
  </section>
</BaseLayout>