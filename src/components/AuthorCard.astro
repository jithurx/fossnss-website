---
import { getEntry } from 'astro:content';
import { Image } from 'astro:assets';
import { getImageUrl } from '../utils/imageUrl';

interface Props {
  username?: string;
  name?: string;
}

const { username, name } = Astro.props;

// Try to find the author in members collection if username is provided
let memberData = null;
if (username) {
  // Search through all years in members collection
  const years = ['2020', '2021', '2022', '2023', '2024', '2025'];
  for (const year of years) {
    try {
      memberData = await getEntry('members', `${year}/${username}`);
      if (memberData) break;
    } catch (e) {
      // Continue searching if not found in this year
      continue;
    }
  }
}

// Fallback to just name if member not found
const displayName = memberData?.data?.name || name || username;
const fallbackImageUrl = getImageUrl("/img/user-profile.jpg");
let avatarUrl = fallbackImageUrl;

// Try to get avatar in order of preference: member avatar > github avatar > fallback
if (memberData?.data?.avathar) {
  avatarUrl = memberData.data.avathar;
} else if (username) {
  try {
    // Check if GitHub avatar exists
    const response = await fetch(`https://github.com/${username}.png?size=100`, { method: 'HEAD' });
    if (response.ok) {
      avatarUrl = `https://github.com/${username}.png?size=100`;
    }
  } catch (e) {
    // If fetch fails, use fallback
    avatarUrl = fallbackImageUrl;
  }
}

const githubUrl = username ? `https://github.com/${username}` : memberData?.data?.url;
---

<div class="flex items-center gap-3 my-4">
  {githubUrl ? (
    <a href={githubUrl} target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
      {avatarUrl && (
        <img 
          src={avatarUrl} 
          alt={`${displayName}'s avatar`}
          class="w-12 h-12 rounded-full object-cover"
        />
      )}
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 hover:underline">{displayName}</h3>
    </a>
  ) : (
    <div class="flex items-center gap-3">
      {avatarUrl && (
        <img 
          src={avatarUrl} 
          alt={`${displayName}'s avatar`}
          class="w-12 h-12 rounded-full object-cover"
        />
      )}
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">{displayName}</h3>
    </div>
  )}
</div>